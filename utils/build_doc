#!/bin/bash

set -e

if [ ! -e "setup.py" ]; then
	echo "The script must be executed from within the repository's root directory."
	exit
fi

export PYTHONPATH="`pwd`"
ROOT="`pwd`"

DOCS_DIR="`pwd`/docs"

# ----------------------------------------------------

echo "Building Live tests scenarios TOC"
rm $DOCS_DIR/LIVETESTS_SCENARIOS_*.rst

echo ".. DO NOT EDIT: this file is automatically created by /utils/build_doc" > $DOCS_DIR/LIVETESTS_SCENARIOS.rst
echo "" >> $DOCS_DIR/LIVETESTS_SCENARIOS.rst
echo ".. toctree::" >> $DOCS_DIR/LIVETESTS_SCENARIOS.rst
echo "   :maxdepth: 1" >> $DOCS_DIR/LIVETESTS_SCENARIOS.rst
echo "" >> $DOCS_DIR/LIVETESTS_SCENARIOS.rst

cd tests/live_tests/scenarios/
for d in */; do
	SCENARIO_NAME=`basename $d`
	if [ -e "$SCENARIO_NAME/README.rst" ]; then
		echo ".. include:: ../tests/live_tests/scenarios/$SCENARIO_NAME/README.rst" > $DOCS_DIR/LIVETESTS_SCENARIOS_$SCENARIO_NAME.rst
		echo "   LIVETESTS_SCENARIOS_$SCENARIO_NAME" >> $DOCS_DIR/LIVETESTS_SCENARIOS.rst
	fi
done

cd $ROOT

# ----------------------------------------------------

echo "Building examples"
rm $DOCS_DIR/EXAMPLES.rst

echo ".. DO NOT EDIT: this file is automatically created by /utils/build_doc" > $DOCS_DIR/EXAMPLES.rst
echo "" >> $DOCS_DIR/EXAMPLES.rst
echo "Examples of configurations" >> $DOCS_DIR/EXAMPLES.rst
echo "==========================" >> $DOCS_DIR/EXAMPLES.rst

cd examples
for d in */; do
	EXAMPLE_NAME=`basename $d`
	if [ -e "$EXAMPLE_NAME/README.rst" ]; then
		echo "" >> $DOCS_DIR/EXAMPLES.rst
		cat $d/README.rst >> $DOCS_DIR/EXAMPLES.rst
		echo "" >> $DOCS_DIR/EXAMPLES.rst
		echo "https://github.com/pierky/arouteserver/blob/master/examples/$EXAMPLE_NAME" >> $DOCS_DIR/EXAMPLES.rst
		echo "" >> $DOCS_DIR/EXAMPLES.rst
		echo "See the \`textual representation of this configuration <_static/examples_$EXAMPLE_NAME.html>\`_." >> $DOCS_DIR/EXAMPLES.rst
	fi
done

cd $ROOT

# ----------------------------------------------------

echo "Generating examples configurations"

function RenderExample() {
	CFG_FILE="var/arouteserver.yml"

	DST="$1" ; shift
	COMMAND="$1" ; shift
	GENERAL="$1" ; shift
	CLIENTS="$1" ; shift
	BOGONS="$1" ; shift

	CMD="./scripts/arouteserver $COMMAND --cfg $CFG_FILE --general $GENERAL --clients $CLIENTS --bogons $BOGONS"

	if [ "$COMMAND" == "build" ]; then
		IP_VER="$1" ; shift
		$CMD --ip-ver $IP_VER -o examples/$DST/bird$IP_VER.conf
	elif [ "$COMMAND" == "html" ]; then
		$CMD -o examples/$DST/description.html
		cp examples/$DST/description.html $DOCS_DIR/_static/examples_$DST.html
	else
		echo "Command unknown: $COMMAND"
	fi
}


echo "Building example: default, IPv4"
RenderExample "default" "build" "config.d/general.yml" "config.d/clients.yml" "config.d/bogons.yml" 4

echo "Building example: default, IPv6"
RenderExample "default" "build" "config.d/general.yml" "config.d/clients.yml" "config.d/bogons.yml" 6

echo "Building example HTML: default"
RenderExample "default" "html" "config.d/general.yml" "config.d/clients.yml" "config.d/bogons.yml"

echo "Building example: rich, IPv4"
RenderExample "rich" "build" "examples/rich/general.yml" "examples/rich/clients.yml" "config.d/bogons.yml" 4

echo "Building example: rich, IPv6"
RenderExample "rich" "build" "examples/rich/general.yml" "examples/rich/clients.yml" "config.d/bogons.yml" 6

echo "Building example HTML: rich"
RenderExample "rich" "html" "examples/rich/general.yml" "examples/rich/clients.yml" "config.d/bogons.yml"

# ----------------------------------------------------

echo "Building README.rst"

echo ".. DO NOT EDIT: this file is automatically created by /utils/build_doc" > README.rst
echo "" >> README.rst
cat $DOCS_DIR/README_header.txt >> README.rst
cat $DOCS_DIR/FEATURES.rst >> README.rst
cat $DOCS_DIR/README_footer.txt >> README.rst

# ----------------------------------------------------

echo "Publishing docs via HTTP"

echo "cd $DOCS_DIR ; make html ; cd _build/html/ ; python -m SimpleHTTPServer 8000 ; cd $ROOT"
cd $DOCS_DIR
make html
cd _build/html/
python -m SimpleHTTPServer 8000
cd $ROOT
